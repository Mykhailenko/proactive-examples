<?xml version="1.0" encoding="UTF-8"?>
<job
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="urn:proactive:jobdescriptor:3.12"
        xsi:schemaLocation="urn:proactive:jobdescriptor:3.12 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.12/schedulerjob.xsd"
        name="File Trigger v2" projectName="1. Basic Workflows" priority="normal" onTaskError="continueJobExecution"
        maxNumberOfExecution="2">
    <variables>
        <variable name="HOST" value="trydev.activeeon.com" model="PA:LIST(,trydev.activeeon.com)"/>
        <variable name="FOLDER_TO_MONITOR" value="/tmp/trigger"/>
    </variables>
    <description>
        <![CDATA[ Process a file whenever the file is created in a specified folder. For the sake of this example, the monitoring loop will stop after 5 times (see loop code). ]]>
    </description>
    <genericInformation>
        <info name="bucketName" value="basic-examples"/>
        <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/file_trigger.png"/>
        <info name="group" value="public-objects"/>
    </genericInformation>
    <taskFlow>
        <task name="FileTrigger"

              onTaskError="suspendTask"


              fork="true">
            <description>
                <![CDATA[ This groovy task check if new files are created in a specified folder (FOLDER_TO_MONITOR). If that is the case, it will pass the file name to the Process Task ]]>
            </description>
            <variables>
                <variable name="FOLDER_TO_MONITOR" value="/tmp/trigger" inherited="true"/>
            </variables>
            <genericInformation>
                <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/file_trigger.png"/>
            </genericInformation>
            <depends>
                <task ref="Init"/>
            </depends>
            <selection>
                <script type="dynamic">
                    <code language="groovy">
                        <![CDATA[
import groovy.io.FileType
inputFilesFolder = new File(variables.get("FOLDER_TO_MONITOR"));

filesToProcess = new ArrayList();

channelId = variables.get("TRIGGERED_CHANNEL")

selected = false;

// list files in the watched folder
inputFilesFolder.eachFileRecurse(FileType.FILES, { file->
key = file.getAbsolutePath()
if (!synchronizationapi.containsKey(channelId, key)) {
// if key is not there then we spotted a new file
selected = true;
}
})



]]>
                    </code>
                </script>
            </selection>
            <scriptExecutable>
                <script>
                    <code language="groovy">
                        <![CDATA[
import groovy.io.FileType

inputFilesFolder = new File(variables.get("FOLDER_TO_MONITOR"))

filesToProcess = new LinkedList();

channelId = variables.get("TRIGGERED_CHANNEL")

// list files in the watched folder
inputFilesFolder.eachFileRecurse(FileType.FILES, { file->
key = file.getAbsolutePath()
value = true // we no need value, so it is always true
previousValue = synchronizationapi.putIfAbsent(channelId, key, value)
if (previousValue == null) {
// then we found new file which was apparently added
filesToProcess.add(key)
}
})

result = filesToProcess;
]]>
                    </code>
                </script>
            </scriptExecutable>
            <controlFlow block="start">
                <replicate>
                    <script>
                        <code language="groovy">
                            <![CDATA[
runs = result.size()
]]>
                        </code>
                    </script>
                </replicate>
            </controlFlow>
            <metadata>
                <positionTop>
                    434.20001220703125
                </positionTop>
                <positionLeft>
                    526
                </positionLeft>
            </metadata>
        </task>
        <task name="Process"


              fork="true">
            <description>
                <![CDATA[ This task will be replicated according to the 'runs' value specified in
the replication script.
The replication index is used in each task's instance to select the
input. ]]>
            </description>
            <genericInformation>
                <info name="TASK.ICON" value="/automation-dashboard/styles/patterns/img/wf-icons/print_file_name.png"/>
            </genericInformation>
            <depends>
                <task ref="FileTrigger"/>
            </depends>
            <scriptExecutable>
                <script>
                    <code language="groovy">
                        <![CDATA[
int replication = variables.get('PA_TASK_REPLICATION')
input = results[0].value()[replication]

print("Ready to process " + input)
result = input.toUpperCase()


//Uncomment the following to submit a workflow for every file found
/*
variables = new HashMap()
variables.put("file", input)
schedulerapi.connect();
jobid = schedulerapi.submitFromCatalog("https://try.activeeon.com/catalog","basic-examples", "print_file_name", variables);
println "Triggered job " + jobid + " to process " + input;
schedulerapi.disconnect();
*/
]]>
                    </code>
                </script>
            </scriptExecutable>
            <metadata>
                <positionTop>
                    561.2000122070312
                </positionTop>
                <positionLeft>
                    520
                </positionLeft>
            </metadata>
        </task>
        <task name="Merge"


              fork="true">
            <description>
                <![CDATA[ As a merge operation, we simply print the results from previous tasks. ]]>
            </description>
            <genericInformation>
                <info name="TASK.ICON"
                      value="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png"/>
            </genericInformation>
            <depends>
                <task ref="Process"/>
            </depends>
            <scriptExecutable>
                <script>
                    <code language="groovy">
                        <![CDATA[
println results
]]>
                    </code>
                </script>
            </scriptExecutable>
            <controlFlow block="end">
                <loop target="FileTrigger">
                    <script>
                        <code language="groovy">
                            <![CDATA[
loop = true;
]]>
                        </code>
                    </script>
                </loop>
            </controlFlow>
            <metadata>
                <positionTop>
                    687.2000122070312
                </positionTop>
                <positionLeft>
                    557
                </positionLeft>
            </metadata>
        </task>
        <task name="Init"


              fork="true">
            <description>
                <![CDATA[ The simplest task, ran by a Groovy engine. ]]>
            </description>
            <selection>
                <script type="static">
                    <file url="${PA_CATALOG_REST_URL}/buckets/scripts/resources/check_host_name/raw" language="groovy">
                        <arguments>
                            <argument value="${HOST}"/>
                        </arguments>
                    </file>
                </script>
            </selection>
            <scriptExecutable>
                <script>
                    <code language="groovy">
                        <![CDATA[
inputFilesFolder = variables.get("FOLDER_TO_MONITOR");

println("Monitoring " + inputFilesFolder)



channelId = "FileTrigger_" + variables.get("PA_JOB_ID")

variables.put("TRIGGERED_CHANNEL", channelId);

synchronizationapi.createChannel(channelId, true)
]]>
                    </code>
                </script>
            </scriptExecutable>
            <metadata>
                <positionTop>
                    317.6166687011719
                </positionTop>
                <positionLeft>
                    520.3999633789062
                </positionLeft>
            </metadata>
        </task>
    </taskFlow>
    <metadata>
        <visualization>
            <![CDATA[ <html><head><link rel="stylesheet" href="/studio/styles/studio-standalone.css"><style>
#workflow-designer {
left:0 !important;
top:0 !important;
width:2602px;
height:3035px;
}
</style></head><body><div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-312.6166687011719px;left:-515px"><div class="task block-start ui-draggable _jsPlumb_endpoint_anchor_ active-task" style="top: 434.2px; left: 526px;" id="jsPlumb_1_100"><a class="task-name"><img src="/automation-dashboard/styles/patterns/img/wf-icons/file_trigger.png" width="20px">&nbsp;<span class="name">FileTrigger</span></a></div><div class="task ui-draggable _jsPlumb_endpoint_anchor_" style="top: 561.2px; left: 520px;" id="jsPlumb_1_103"><a class="task-name"><img src="/automation-dashboard/styles/patterns/img/wf-icons/print_file_name.png" width="20px">&nbsp;<span class="name">Process</span></a></div><div class="task block-end ui-draggable _jsPlumb_endpoint_anchor_" style="top: 687.2px; left: 557px;" id="jsPlumb_1_106"><a class="task-name"><img src="/automation-dashboard/styles/patterns/img/wf-icons/controls_replicate.png" width="20px">&nbsp;<span class="name">Merge</span></a></div><div class="task _jsPlumb_endpoint_anchor_ ui-draggable" style="top: 317.617px; left: 520.4px;" id="jsPlumb_1_109"><a class="task-name"><img src="images/Groovy.png" width="20px">&nbsp;<span class="name">Init</span></a></div><svg style="position:absolute;left:559.5px;top:357.5px" width="27" height="77" pointer-events="none" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 6 76 C 16 26 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M8.330112,57.076992000000004 L13.109653878326782,36.43344629115143 L6.804954419742401,43.16031515689616 L-0.8070229647770635,37.958603871409025 L8.330112,57.076992000000004" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M8.330112,57.076992000000004 L13.109653878326782,36.43344629115143 L6.804954419742401,43.16031515689616 L-0.8070229647770635,37.958603871409025 L8.330112,57.076992000000004" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:589.5px;top:463.5px" width="27" height="98" pointer-events="none" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 87 C -10 87 16 -10 6 0 " transform="translate(10.5,10.5)" pointer-events="visibleStroke" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#e5db3d" style=""></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M-2.231589,76.5282105 L6.6987208927915,57.31234296250094 L-0.8566853222567661,62.59588693654052 L-7.233602670667975,55.93743928475771 L-2.231589,76.5282105" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(10.5,10.5)"></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M-2.231589,76.5282105 L6.6987208927915,57.31234296250094 L-0.8566853222567661,62.59588693654052 L-7.233602670667975,55.93743928475771 L-2.231589,76.5282105" class="" stroke="rgba(229,219,61,0.5)" fill="rgba(229,219,61,0.5)" transform="translate(10.5,10.5)"></path></svg><div style="position: absolute; transform: translate(-50%, -50%); left: 602.5px; top: 513.25px;" class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_120">replicate</div><svg style="position:absolute;left:559.5px;top:473.5px" width="27" height="88" pointer-events="none" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector"><path d="M 0 87 C -10 37 16 50 6 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M-2.3283750000000003,65.86284375000001 L6.772860278626977,46.7273396698072 L-0.8293405274907395,51.9433288284868 L-7.146654642886233,45.228305197297935 L-2.3283750000000003,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M-2.3283750000000003,65.86284375000001 L6.772860278626977,46.7273396698072 L-0.8293405274907395,51.9433288284868 L-7.146654642886233,45.228305197297935 L-2.3283750000000003,65.86284375000001" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:559.5px;top:600.5px" width="58" height="87" pointer-events="none" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 37 86 C 47 36 -10 50 0 0 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#666" style=""></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M36.363006000000006,63.55324800000002 L32.795916169070956,42.666030135045325 L29.57963739548844,51.30637450611078 L20.549042675181717,49.44939873955689 L36.363006000000006,63.55324800000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M36.363006000000006,63.55324800000002 L32.795916169070956,42.666030135045325 L29.57963739548844,51.30637450611078 L20.549042675181717,49.44939873955689 L36.363006000000006,63.55324800000002" class="" stroke="#666" fill="#666" transform="translate(10.5,0.5)"></path></svg><svg style="position:absolute;left:615.5px;top:473.5px" width="52" height="214" pointer-events="none" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" class="_jsPlumb_connector "><path d="M 0 0 C -10 50 41 163 31 213 " transform="translate(10.5,0.5)" pointer-events="visibleStroke" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="none" stroke="#316b31" style=""></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M2.22664725,48.45047175 L12.870651162884723,66.77273090935299 L4.865265731049286,62.19956962991434 L-0.8784467170296226,69.41134939040228 L2.22664725,48.45047175" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path><path pointer-events="all" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" d="M2.22664725,48.45047175 L12.870651162884723,66.77273090935299 L4.865265731049286,62.19956962991434 L-0.8784467170296226,69.41134939040228 L2.22664725,48.45047175" class="" stroke="#316b31" fill="#316b31" transform="translate(10.5,0.5)"></path></svg><div style="position: absolute; transform: translate(-50%, -50%); left: 641px; top: 580px;" class="_jsPlumb_overlay l1 component label" id="jsPlumb_1_132">loop</div><div style="position: absolute; height: 20px; width: 20px; left: 566px; top: 464px;" class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 566px; top: 424px;" class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 596px; top: 464px;" class="_jsPlumb_endpoint source-endpoint replicate-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 616px; top: 464px;" class="_jsPlumb_endpoint target-endpoint loop-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 560px; top: 591px;" class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 590px; top: 551px;" class="_jsPlumb_endpoint target-endpoint replicate-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#e5db3d" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 560px; top: 551px;" class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 597px; top: 717px;" class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 597px; top: 677px;" class="_jsPlumb_endpoint target-endpoint dependency-target-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 647px; top: 677px;" class="_jsPlumb_endpoint source-endpoint loop-source-endpoint _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected _jsPlumb_endpoint_full"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#316b31" stroke="none" style=""></circle></svg></div><div style="position: absolute; height: 20px; width: 20px; left: 560px; top: 348px;" class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable _jsPlumb_endpoint_connected"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1"
xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1"
xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div></body></html>
]]>
        </visualization>
    </metadata>
</job>